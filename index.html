<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrena Pro</title>
    <meta name="description" content="Plan de entrenamiento progresivo de 3 meses con im谩genes y consejos nutricionales.">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:auto}
        .loader-small{border:2px solid #f3f3f3;border-top:2px solid #22c55e;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;margin:8px auto}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .tab-active{border-bottom-color:#3b82f6;color:#3b82f6}
        @media print{.no-print{display:none}body{background:white}.shadow-xl{box-shadow:none}}
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
    <header class="bg-blue-600 text-white p-6 text-center">
        <h1 class="text-3xl font-bold">Plan de Entrenamiento Progresivo</h1>
        <p class="text-blue-100 mt-1">3 Meses - 1 D铆a por Semana</p>
        <p class="text-xs mt-2">Instala esta app en tu m贸vil</p>
    </header>
    <main class="p-6 md:p-8">
        <div class="border-b border-gray-200 mb-6 no-print">
            <nav class="-mb-px flex space-x-4 md:space-x-8">
                <button id="tab-mes1" class="tab-button tab-active py-3 px-1 border-b-2 font-medium text-sm" onclick="showTab('mes1')">Mes 1: Adaptaci贸n</button>
                <button id="tab-mes2" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm" onclick="showTab('mes2')">Mes 2: Consolidaci贸n</button>
                <button id="tab-mes3" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm" onclick="showTab('mes3')">Mes 3: Intensificaci贸n</button>
            </nav>
        </div>
        <div class="text-center mb-6 no-print">
            <button onclick="window.print()" class="px-6 py-2 bg-green-600 text-white rounded-full hover:bg-green-700 shadow-md">
                 Imprimir / PDF
            </button>
        </div>
        <div id="tab-content-mes1" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Rutina Mes 1: 2 Series</h2>
            <div id="plan-mes1" class="space-y-6"></div>
        </div>
        <div id="tab-content-mes2" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Rutina Mes 2: 3 Series</h2>
            <div id="plan-mes2" class="space-y-6"></div>
        </div>
        <div id="tab-content-mes3" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Rutina Mes 3: 3 Series</h2>
            <div id="plan-mes3" class="space-y-6"></div>
        </div>
    </main>
</div>

<script>
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{});
}
const apiKey = "";
const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

const planData = {
    mes1: [/* ... todo el planData del mensaje anterior ... */],
    mes2: [/* ... */],
    mes3: [/* ... */]
};

// === FUNCIONES (generateImage, generateNutritionTip, createExerciseCard, renderPlan, showTab) ===
async function generateImage(prompt, elementId) {
    const imgContainer = document.getElementById(elementId);
    if (!imgContainer) return;
    imgContainer.innerHTML = '<div class="loader"></div>';
    const payload = { instances: { prompt }, parameters: { sampleCount: 1 } };
    let retries = 0, delay = 1000;
    while (retries < 3) {
        try {
            const res = await fetch(imageApiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            if (!res.ok && ![429,500].includes(res.status)) {
                imgContainer.innerHTML = '<p class="text-red-500 text-xs">Error API</p>'; return;
            }
            if (!res.ok) throw new Error();
            const data = await res.json();
            if (data.predictions?.[0]?.bytesBase64Encoded) {
                imgContainer.innerHTML = `<img src="data:image/png;base64,${data.predictions[0].bytesBase64Encoded}" class="w-full h-auto rounded-md border">`;
                return;
            }
        } catch { retries++; if (retries < 3) await new Promise(r=>setTimeout(r,delay*=2)); }
    }
    imgContainer.innerHTML = '<p class="text-red-500 text-xs">Fall贸 imagen</p>';
}

async function generateNutritionTip(title, id) {
    const el = document.getElementById(id); if (!el) return;
    el.innerHTML = '<div class="loader-small"></div>';
    const payload = {
        contents: [{ parts: [{ text: `Consejo nutricional para: ${title}` }] }],
        systemInstruction: { parts: [{ text: "Da un consejo corto y pr谩ctico de nutrici贸n para este ejercicio." }] },
        tools: [{ google_search: {} }]
    };
    let retries = 0, delay = 1000;
    while (retries < 3) {
        try {
            const res = await fetch(textApiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error();
            const data = await res.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Come prote铆na despu茅s.";
            el.innerHTML = `<p class="text-xs text-green-700 p-2 bg-green-50 rounded-lg">${text}</p>`;
            return;
        } catch { retries++; if (retries < 3) await new Promise(r=>setTimeout(r,delay*=2)); }
    }
    el.innerHTML = '<p class="text-red-500 text-xs">Fall贸 consejo</p>';
}

function createExerciseCard(ex) {
    return `
        <div class="border rounded-lg overflow-hidden shadow-sm">
            <div class="p-4 bg-gray-50">
                <h3 class="text-lg font-semibold text-blue-700">${ex.titulo}</h3>
                <p class="text-sm font-medium text-gray-600">${ex.reps}</p>
            </div>
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-700">${ex.tecnica}</p>
                    <button onclick="generateNutritionTip('${ex.titulo}', 'tip-${ex.id}')" class="mt-3 px-3 py-1 bg-green-500 text-white text-xs rounded-full hover:bg-green-600">Nutrici贸n</button>
                    <div id="tip-${ex.id}" class="mt-2 min-h-[30px]"></div>
                </div>
                <div id="${ex.id}-img" class="w-full min-h-40 bg-gray-100 rounded-md flex items-center justify-center"></div>
            </div>
        </div>`;
}

function renderPlan() {
    document.getElementById('plan-mes1').innerHTML = planData.mes1.map(createExerciseCard).join('');
    document.getElementById('plan-mes2').innerHTML = planData.mes2.map(createExerciseCard).join('');
    document.getElementById('plan-mes3').innerHTML = planData.mes3.map(createExerciseCard).join('');
    [...planData.mes1, ...planData.mes2, ...planData.mes3].forEach(ex => generateImage(ex.prompt, `${ex.id}-img`));
}

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500','border-transparent'); });
    document.getElementById(`tab-content-${id}`).classList.remove('hidden');
    const btn = document.getElementById(`tab-${id}`);
    btn.classList.add('tab-active'); btn.classList.remove('text-gray-500','border-transparent');
}

window.onload = () => {
    renderPlan();
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault(); deferredPrompt = e;
        const btn = document.createElement('button');
        btn.innerText = ' Instalar';
        btn.className = 'fixed bottom-4 right-4 z-50 px-5 py-3 bg-blue-600 text-white rounded-full shadow-lg';
        btn.onclick = () => { deferredPrompt.prompt(); btn.remove(); };
        document.body.appendChild(btn);
    });
};
</script>
</body>
</html>